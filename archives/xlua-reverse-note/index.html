<!DOCTYPE html>
<html lang="zh-cn">

<head>
	<title>某游戏 xLua 逆向笔记 | Berd&#039;s Playground (Deprecated)</title>

	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="theme_author" content="dimpurr">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="application-name" content="Berd&#039;s Playground (Deprecated)">

	<link rel="stylesheet" href="/wp-content/themes/clearision/style.css?t=1616595409">
	<link rel="stylesheet" href="/wp-content/themes/clearision/style.opacity.css?t=1616595500">
<style>body { background-image: url("https://static.berd.moe/images/background_repeat.png"); }</style>
	<link rel="home" href="/">
	<link rel="profile" href="https://gmpg.org/xfn/11">
	<link rel="pingback" href="/xmlrpc.php">
	<link rel="shortcut icon" type="image/x-icon">

	<link rel="alternate" type="application/rdf+xml" title="RSS 1.0" href="/feed/rss/">
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed/">
	<link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/feed/atom/">

	<!--[if lt IE 9]>
	<script src="/wp-content/themes/clearision/js/html5shiv.min.js" type="text/javascript"></script>
	<![endif]-->

	<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="//s.w.org">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.1.0\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.8"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([10084,65039,8205,55357,56613],[10084,65039,8203,55357,56613])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}</style>
	<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=5.8" type="text/css" media="all">
<link rel="stylesheet" id="azc-tsh-css" href="/wp-content/plugins/azurecurve-toggle-showhide/style.css?ver=1.0.0" type="text/css" media="all">
<style id="azc-tsh-inline-css" type="text/css">.azc_tsh_toggle_active {
							background-image: url(/wp-content/plugins/azurecurve-toggle-showhide/images/azure_up.png) !important;
						}
						.azc_tsh_toggle_open_active {
							background-image: url(/wp-content/plugins/azurecurve-toggle-showhide/images/azure_up.png);
						}
						.azc_tsh_toggle {
							background-image: url(/wp-content/plugins/azurecurve-toggle-showhide/images/azure_down.png);
						}
						.azc_tsh_toggle_open {
							background-image: url(/wp-content/plugins/azurecurve-toggle-showhide/images/azure_down.png) !important;
						}</style>
<script type="text/javascript" src="/wp-includes/js/jquery/jquery.min.js?ver=3.6.0" id="jquery-core-js"></script>
<script type="text/javascript" src="/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2" id="jquery-migrate-js"></script>
<script type="text/javascript" src="/wp-content/plugins/azurecurve-toggle-showhide/jquery.js?ver=3.9.1" id="azc-tsh-js"></script>
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/813">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 5.8">
<link rel="canonical" href="/archives/xlua-reverse-note/">
<link rel="shortlink" href="/?p=813">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2Farchives%2Fxlua-reverse-note%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2Farchives%2Fxlua-reverse-note%2F&#038;format=xml">
<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<link rel="icon" href="/wp-content/uploads/2019/05/icon.png" sizes="32x32">
<link rel="icon" href="/wp-content/uploads/2019/05/icon.png" sizes="192x192">
<link rel="apple-touch-icon" href="/wp-content/uploads/2019/05/icon.png">
<meta name="msapplication-TileImage" content="/wp-content/uploads/2019/05/icon.png">
		<style type="text/css" id="wp-custom-css">/*
You can add your own CSS here.

Click the help icon above to learn more.
*/
body > * {
	filter: grayscale();
}</style>
		</head>

<body class="post-template-default single single-post postid-813 single-format-standard">
	<div id="page">
		<hgroup id="ctn_header">
			<div id="title">
				<h1 id="site-title">
					<span>
						<a href="/" title="Berd&#039;s Playground (Deprecated)" rel="home">Berd&#039;s Playground (Deprecated)</a>
					</span>
				</h1>
				<h2 id="site-description">Won&#039;t receive any further updates.</h2>
			</div>
			<div id="title_r">
								<a href="/feed/" target="_blank"><button id="tr_rss"></button></a>
				<a href="/wp-admin/" target="_blank"><button id="tr_admin"></button></a>
				<span id="tr_clear"></span>
				<form id="tr_s_f" method="get" action="/">
					<input id="tr_search" type="text" name="s" placeholder="" size="10">
				</form>
			</div>
			<div class="clearfix"></div>
		</hgroup>
		<div id="float">
			<a href="/" title="Berd&#039;s Playground (Deprecated)" rel="home">
				<img id="logo" alt="Berd&#039;s Playground (Deprecated)" title="Berd&#039;s Playground (Deprecated)" src="/wp-content/uploads/2019/05/icon.png">
			</a>
			<nav id="nav" role="navigation">
				<div class="menu-sliding-main-menu-container"><ul id="menu-sliding-main-menu" class="menu">
<li id="menu-item-388" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-388"><a href="/categories/magic/">技术</a></li>
<li id="menu-item-371" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-371"><a href="/categories/magic/repair/">踩坑</a></li>
<li id="menu-item-372" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-372"><a href="/categories/magic/code/">迷の代码</a></li>
<li id="menu-item-373" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-373"><a href="/categories/magic/diy/">硬核魔改</a></li>
<li id="menu-item-374" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-374"><a href="/categories/other/">零碎内容</a></li>
</ul></div>			</nav>
			<nav id="next" role="sencond_navigation">
				<div class="menu-sliding-assist-menu-container"><ul id="menu-sliding-assist-menu" class="menu">
<li id="menu-item-101" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-101"><a href="/about/">关于 &#038; 留言板</a></li>
</ul></div>			</nav>
		</div>
<div id="ctn">
	<div id="content">
					<article class="post-813 post type-post status-publish format-standard hentry category-code tag-lua tag-reverse tag-xlua">
				<hgroup class="post_hctn">
	<div class="post_time">
		<div class="post_t_d">09/21</div>
		<div class="post_t_u">21:17</div>
	</div>

	<div class="post_h_l">
		<span class="post_ct"><a href="/categories/magic/code/" rel="category tag">迷の代码</a></span>
		<h2 class="post_h"><a href="/archives/xlua-reverse-note/">某游戏 xLua 逆向笔记</a></h2>

		<div class="post_tag">
			
			<a href="/tags/lua/" rel="tag">Lua</a> <a href="/tags/reverse/" rel="tag">Reverse</a> <a href="/tags/xlua/" rel="tag">xLua</a>
			<span class="post_c">
				<a href="/archives/xlua-reverse-note/#respond">No Reply</a>

				
							</span>
		</div>
	</div>
</hgroup>

<div class="post_t">
			
<h2>0x00 前言</h2>



<p>最近好像某款游戏挺火的，虽然我没怎么关注，不过群友在拆着玩，所以我也来凑个热闹 <img src="/wp-content/plugins/tiebaface/images/yellow_25.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;"></p>



<p>因为我压根没装游戏，搞逆向调试啥的基本不可能，群友就给我扔了一堆 luac 来拆着玩，之前我也没拆过这种 lua 游戏，正好学习一下，于是就有了这篇博客 <img src="/wp-content/plugins/tiebaface/images/yellow_16.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;"></p>



<figure class="wp-block-image size-large is-resized"><img loading="lazy" src="/wp-content/uploads/2020/09/image-22-1024x621.png" alt="" class="wp-image-836" width="580" height="351" srcset="/wp-content/uploads/2020/09/image-22-1024x621.png 1024w, /wp-content/uploads/2020/09/image-22-300x182.png 300w, /wp-content/uploads/2020/09/image-22-768x466.png 768w, /wp-content/uploads/2020/09/image-22.png 1037w" sizes="(max-width: 580px) 100vw, 580px"></figure>



<span id="more-813"></span>



<h2>0x01 基本分析</h2>



<p>拿到一堆 luac 后，第一件事当然是扔到 <a rel="noreferrer noopener" href="https://sourceforge.net/projects/unluac/" target="_blank">unluac</a> 这个万能工具里面去跑一下看看能不能直接解开啦:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="979" height="512" src="/wp-content/uploads/2020/09/image.png" alt="" class="wp-image-814" srcset="/wp-content/uploads/2020/09/image.png 979w, /wp-content/uploads/2020/09/image-300x157.png 300w, /wp-content/uploads/2020/09/image-768x402.png 768w" sizes="(max-width: 979px) 100vw, 979px"></figure>



<p>意料之内的报错了，错误提示 &#8220;The input chunk reports a non-standard lua format: 1&#8221;</p>



<p>让我们挑一个小一点的 luac 来研究一下:</p>



<p>用 HEX 编辑器打开后，首先要看 lua 版本，有的游戏可能会修改前面的 .Lua 头，但只要确定了是 lua bytecode 而不是 luajit 编译出来的东西，基本上都可以在文件开头找到版本号。这里是 Lua 5.3，结合 xlua.dll 中的 lua 版本字符串可以确定使用的引擎是 lua 5.3.5</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="653" height="641" src="/wp-content/uploads/2020/09/image-1.png" alt="" class="wp-image-815" srcset="/wp-content/uploads/2020/09/image-1.png 653w, /wp-content/uploads/2020/09/image-1-300x294.png 300w" sizes="(max-width: 653px) 100vw, 653px"></figure>



<p>随后我们来分析到底哪些地方是“自定义”的，其实这个“自定义格式”是 xLua 搞出来的而不是游戏公司搞出来的，但我一开始以为这个是游戏公司搞的自定义格式，分析了半天走了不少弯路</p>



<p>这里就走捷径直接到 <a rel="noreferrer noopener" href="https://github.com/Tencent/xLua/" target="_blank">xLua 的仓库中</a> 查看更改，发现这么一条 commit:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="957" height="352" src="/wp-content/uploads/2020/09/image-2.png" alt="" class="wp-image-816" srcset="/wp-content/uploads/2020/09/image-2.png 957w, /wp-content/uploads/2020/09/image-2-300x110.png 300w, /wp-content/uploads/2020/09/image-2-768x282.png 768w" sizes="(max-width: 957px) 100vw, 957px"></figure>



<p>往下追一追，发现启用这个 &#8220;字节码兼容&#8221; 会设置字节码格式为 1 (非官方)</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="284" src="/wp-content/uploads/2020/09/image-3-1024x284.png" alt="" class="wp-image-817" srcset="/wp-content/uploads/2020/09/image-3-1024x284.png 1024w, /wp-content/uploads/2020/09/image-3-300x83.png 300w, /wp-content/uploads/2020/09/image-3-768x213.png 768w, /wp-content/uploads/2020/09/image-3.png 1303w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>并且在 luac 的头部少了一个 size_t 的尺寸，这个 size_t 被换成了 uint32_t，也就是说尺寸固定为 4</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="630" height="436" src="/wp-content/uploads/2020/09/image-4.png" alt="" class="wp-image-818" srcset="/wp-content/uploads/2020/09/image-4.png 630w, /wp-content/uploads/2020/09/image-4-300x208.png 300w" sizes="(max-width: 630px) 100vw, 630px"></figure>



<p>了解这些信息后，我们就可以 Patch 掉这个 luac 的头部再丢给 unluac 看看了，如图将 01 修改为 00，并增加 size_t 的尺寸 04</p>



<p>顺便一提下面大块绿色的部分就是一堆 Instruction，前面的紫色区域就是这一堆 Instruction 的数量，在 lua 5.3 中指令长度是 4 个字节，所以我在 010 Editor 里建书签的时候直接建了 <code>signed int [指令数量]</code> 这么一个大数组就可以准确的分出代码区域</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="622" height="208" src="/wp-content/uploads/2020/09/image-5.png" alt="" class="wp-image-819" srcset="/wp-content/uploads/2020/09/image-5.png 622w, /wp-content/uploads/2020/09/image-5-300x100.png 300w" sizes="(max-width: 622px) 100vw, 622px"></figure>



<p><strong>注意: 这种暴力 Patch 是可能出现问题的 (虽然现在没碰到)，推荐的做法是修改 unluac 的源码来兼容数据而不是修改数据头来适配 unluac</strong></p>



<p>假如游戏没有修改 OPCode，那么这篇文章到此就结束了，不过，本例中使用的游戏修改了 OPCode 映射表，因此 unluac 依然无法正常解析</p>



<p>另外，使用 unluac 时看到这个 IllegalStateException 基本就可以肯定 OPCode 被改过了，如果看到的是 Underflow 这种异常，则应该去检查 lua 头中的各个数据类型的尺寸是否有误</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="772" height="199" src="/wp-content/uploads/2020/09/image-6.png" alt="" class="wp-image-820" srcset="/wp-content/uploads/2020/09/image-6.png 772w, /wp-content/uploads/2020/09/image-6-300x77.png 300w, /wp-content/uploads/2020/09/image-6-768x198.png 768w" sizes="(max-width: 772px) 100vw, 772px"></figure>



<h2>0x02 寻找 OPCode</h2>



<p>接下来我们要做的事情就是寻找 OPCode 的对应关系。对于 5.3.15 版本的 lua而言，总共有 47 个 OP，定义于 <code>src\lopcodes.h</code> 中</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="772" height="908" src="/wp-content/uploads/2020/09/image-7.png" alt="" class="wp-image-821" srcset="/wp-content/uploads/2020/09/image-7.png 772w, /wp-content/uploads/2020/09/image-7-255x300.png 255w, /wp-content/uploads/2020/09/image-7-768x903.png 768w" sizes="(max-width: 772px) 100vw, 772px"></figure>



<p>假如游戏开发者非常认真的按照注释中的说明去改了，我们可以直接去找位于 <code>src\lopcodes.c</code> 的 <code>luaP_opnames</code> 这个数组，通过 IDA 提取直接得出对应关系</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="716" height="887" src="/wp-content/uploads/2020/09/image-8.png" alt="" class="wp-image-822" srcset="/wp-content/uploads/2020/09/image-8.png 716w, /wp-content/uploads/2020/09/image-8-242x300.png 242w" sizes="(max-width: 716px) 100vw, 716px"></figure>



<p>不过开发者明显偷懒了，只是确保游戏能跑就行，根本没动过这个映射表</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="723" height="753" src="/wp-content/uploads/2020/09/image-9.png" alt="" class="wp-image-823" srcset="/wp-content/uploads/2020/09/image-9.png 723w, /wp-content/uploads/2020/09/image-9-288x300.png 288w" sizes="(max-width: 723px) 100vw, 723px"></figure>



<p>由于这些 OP 是通过 enum 定义的，编译后肯定全部是常量，去硬分析反汇编肯定是不现实的</p>



<p>这里就只能用另外一种思路: 让这个 lua 引擎加载一个用到大部分 OP 的 lua 文件，dump 出生成的字节码，然后再通过原版的 lua 引擎加载这个文件并 dump，最后我们通过一个进行比对来得出映射关系</p>



<p>于是我就写了 <a rel="noreferrer noopener" href="https://github.com/fengberd/xLuaDumper" target="_blank">xLuaDumper</a> 这个简单的小程序，加载 xlua.dll 并进行上面说的 dump 流程，使用方法非常简单，只需要执行 <code>xLuaDumper.exe &lt;DLL&gt;</code> 即可:</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="482" height="79" src="/wp-content/uploads/2020/09/image-10.png" alt="" class="wp-image-824" srcset="/wp-content/uploads/2020/09/image-10.png 482w, /wp-content/uploads/2020/09/image-10-300x49.png 300w" sizes="(max-width: 482px) 100vw, 482px"></figure>



<p>然后在研究怎么写一个脚本用上 lua 大部分 OP 的时候我找到了这个帖子 <img src="/wp-content/plugins/tiebaface/images/yellow_33.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;">: <a href="https://bbs.pediy.com/thread-250618.htm">https://bbs.pediy.com/thread-250618.htm</a></p>



<p>不得不承认，这个帖子中说到的思路可能比我的更简单，不过我都到这步了，只好坚持按之前的思路去做 <img src="/wp-content/plugins/tiebaface/images/yellow_16.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;"></p>



<p>参考这个帖子中的 test.lua、部分 OP 的编译逻辑以及 <a rel="noreferrer noopener" href="https://the-ravi-programming-language.readthedocs.io/en/latest/lua_bytecode_reference.html" target="_blank">Lua 5.3 Bytecode Reference</a>，最后我写出了这么一个覆盖了 42 个 OP 的脚本，完整的代码可以在 GitHub 上找到</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="526" height="697" src="/wp-content/uploads/2020/09/image-13.png" alt="" class="wp-image-827" srcset="/wp-content/uploads/2020/09/image-13.png 526w, /wp-content/uploads/2020/09/image-13-226x300.png 226w" sizes="(max-width: 526px) 100vw, 526px"></figure>



<p>剩下的几个 OP (<code>LOADKX, GETUPVAL, SETUPVAL, TESTSET, EXTRAARG</code>) 似乎并不能通过直接加载的方式取得，但 <code>GETUPVAL, SETUPVAL</code> 这两个 OP 还是挺常用的，这部分请自己想办法 <img src="/wp-content/plugins/tiebaface/images/yellow_25.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;"></p>



<p>通过 xLuaDumper 导出两份字节码，然后将其进行比对就可以找到 OP 的映射关系了</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="663" height="205" src="/wp-content/uploads/2020/09/image-12.png" alt="" class="wp-image-826" srcset="/wp-content/uploads/2020/09/image-12.png 663w, /wp-content/uploads/2020/09/image-12-300x93.png 300w" sizes="(max-width: 663px) 100vw, 663px"></figure>



<h2>0x03 生成映射关系</h2>



<p>让我们再回过头看一下两个 luac，图中绿色的部分为指令数量，两个 luac 的指令数量应该完全一样，否则肯定会出错，黄色的部分为具体的指令部分，可以很清晰的看到红色的区域就是有差别的地方</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="434" src="/wp-content/uploads/2020/09/image-20-1024x434.png" alt="" class="wp-image-834" srcset="/wp-content/uploads/2020/09/image-20-1024x434.png 1024w, /wp-content/uploads/2020/09/image-20-300x127.png 300w, /wp-content/uploads/2020/09/image-20-768x325.png 768w, /wp-content/uploads/2020/09/image-20.png 1256w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>当然，这里说红色的部分就是 OP 是不准确的，在 Lua 源代码中我们可以看到只有最低 6 位是 OP，所以我们解析的时候还需要 <code>&amp; 0b111111</code> 才能取到准确的 OP</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="824" height="281" src="/wp-content/uploads/2020/09/image-11.png" alt="" class="wp-image-825" srcset="/wp-content/uploads/2020/09/image-11.png 824w, /wp-content/uploads/2020/09/image-11-300x102.png 300w, /wp-content/uploads/2020/09/image-11-768x262.png 768w" sizes="(max-width: 824px) 100vw, 824px"></figure>



<p>手动比对 OPCode 然后去写映射关系并非不可行，但效率实在是太低了，并且我们还有着修改 unluac 中一大堆映射的需求，因此这里我写了 <code>diff.php</code> 脚本来自动化这个过程</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="979" height="984" src="/wp-content/uploads/2020/09/image-14.png" alt="" class="wp-image-828" srcset="/wp-content/uploads/2020/09/image-14.png 979w, /wp-content/uploads/2020/09/image-14-298x300.png 298w, /wp-content/uploads/2020/09/image-14-150x150.png 150w, /wp-content/uploads/2020/09/image-14-768x772.png 768w" sizes="(max-width: 979px) 100vw, 979px"></figure>



<p>这个脚本会自动调用两次 Dumper 来生成字节码，随后进行映射解析并输出可以直接粘贴到 unluac 源码中的格式及统计 (即底部的几个 Unknown OP)，完整代码依然可以在 GitHub 上找到</p>



<p>特别要说明一下的是下图中红框部分，因为我并不想去写复杂的 Header 解析，所以直接写死了两个 Offset 来切掉 Header</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="670" height="311" src="/wp-content/uploads/2020/09/image-15.png" alt="" class="wp-image-829" srcset="/wp-content/uploads/2020/09/image-15.png 670w, /wp-content/uploads/2020/09/image-15-300x139.png 300w" sizes="(max-width: 670px) 100vw, 670px"></figure>



<p>由于调用 <code>lua_dump</code> 的时候会设置 <code>strip = true</code>，因此拿到的 luac 头部长度应该都是一样的，这么写问题不大</p>



<p><em>如果你使用的 xlua.dll 没有开启兼容模式，应该把上面的 45 也改成 46</em></p>



<p>拿到这一堆代码后，我们就可以直接粘贴到 unluac 的 <code>decompile\OpcodeMap.java</code> 中覆盖掉原来的 OP 定义了，如图所示</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="947" height="1024" src="/wp-content/uploads/2020/09/image-16-947x1024.png" alt="" class="wp-image-830" srcset="/wp-content/uploads/2020/09/image-16-947x1024.png 947w, /wp-content/uploads/2020/09/image-16-277x300.png 277w, /wp-content/uploads/2020/09/image-16-768x830.png 768w, /wp-content/uploads/2020/09/image-16.png 1034w" sizes="(max-width: 947px) 100vw, 947px"></figure>



<p>除此之外，别忘了修改 <code>parse\LHeaderType.java</code> 来适配我们的 luac 格式</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="717" height="663" src="/wp-content/uploads/2020/09/image-21.png" alt="" class="wp-image-835" srcset="/wp-content/uploads/2020/09/image-21.png 717w, /wp-content/uploads/2020/09/image-21-300x277.png 300w" sizes="(max-width: 717px) 100vw, 717px"></figure>



<p>这样我们就获得了一份可以基本正确反汇编这个游戏的 unluac 了 <img src="/wp-content/plugins/tiebaface/images/yellow_16.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;"></p>



<h2>0x04 批量操作</h2>



<p>只是拿到一个可以用的 unluac 当然远远不够，<s>别忘了我们的每个 luac 都需要手动 Patch 一下再拿去反编译，</s>对游戏里大量的 luac 手动做这件事明显不现实</p>



<p>因此我还写了一个 <code>batch.php</code> 来实现自动化操作，同样的完整源码在 GitHub 上可以找到</p>



<p><s>注意红框中的部分</s> <strong>由于不推荐进行这种 Patch，这部分代码已被删除，请参照上文修改 unluac 来适配数据格式</strong></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="867" height="230" src="/wp-content/uploads/2020/09/image-17.png" alt="" class="wp-image-831" srcset="/wp-content/uploads/2020/09/image-17.png 867w, /wp-content/uploads/2020/09/image-17-300x80.png 300w, /wp-content/uploads/2020/09/image-17-768x204.png 768w" sizes="(max-width: 867px) 100vw, 867px"></figure>



<p><s>同样的，当检测到 luac 中 <code>FORMAT = 1</code> 时，这个脚本会尝试自动 Patch 掉这个标志位并在后面加上 size_t 的长度字节，确保 unluac 能正确读取</s></p>



<p>由于我手上的所有 luac 都没有调试信息，Header 长度都是一样的，这个脚本仍然采用了写死长度和数据的形式</p>



<p>最后，运行 <code>batch.php&nbsp;&lt;unluac&gt;&nbsp;&lt;Input&gt;&nbsp;&lt;Output&gt;</code>，我们就拿到完整的lua 代码了 <img src="/wp-content/plugins/tiebaface/images/yellow_25.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;"></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="979" height="544" src="/wp-content/uploads/2020/09/image-18.png" alt="" class="wp-image-832" srcset="/wp-content/uploads/2020/09/image-18.png 979w, /wp-content/uploads/2020/09/image-18-300x167.png 300w, /wp-content/uploads/2020/09/image-18-768x427.png 768w" sizes="(max-width: 979px) 100vw, 979px"></figure>



<p>当然，由于调试信息被抹掉了，我这里拿到的代码可读性非常的差，后面如果闲下来可能会考虑再写 Parser 对其进行优化，总之这篇博客到这里就结束啦 <img src="/wp-content/plugins/tiebaface/images/yellow_25.png" style="width: 24px !important;height: 24px !important;min-height: 0 !important;"></p>



<figure class="wp-block-image size-large"><img loading="lazy" width="711" height="691" src="/wp-content/uploads/2020/09/image-19.png" alt="" class="wp-image-833" srcset="/wp-content/uploads/2020/09/image-19.png 711w, /wp-content/uploads/2020/09/image-19-300x292.png 300w" sizes="(max-width: 711px) 100vw, 711px"></figure>
		<h2 class="post_h_quote">某游戏 xLua 逆向笔记</h2>
</div>				<nav id="post_nav">
					<span id="p_n_l"><a href="/archives/biman-walkthrough/" rel="prev">&larr; 《美少女万华镜》无剧透全流程攻略</a></span>
					<span id="p_n_r"><a href="/archives/chrome-spyware-extension-user-agent-switcher/" rel="next">Chrome 恶意拓展 User-Agent Switcher 分析笔记 &rarr;</a></span>
				</nav>
				
<div id="cmt" class="cmt">
	
	</div>			</article>
			</div>
</div>

<div id="sidebar">
	<div class="widget" id="one">
			</div>
	<div class="widget" id="two">
			</div>
	<div class="clearfix"></div>
</div>
<footer id="footer" role="contentinfo">
    
    <a href="http://dimpurr.com/" title="Dimpurr (钉子)" target="_blank">Dimpurr</a>'s
    <a href="http://blog.dimpurr.com/clearision/" title="Clearision" target="_blank">Clearision</a><br>
    Powered by <a href="https://wordpress.org/" title="WordPress" target="_blank">WordPress</a>

    <script src="/wp-content/themes/clearision/js/script.js" type="text/javascript"></script>
    <script type="text/javascript" src="/wp-includes/js/wp-embed.min.js?ver=5.8" id="wp-embed-js"></script>
</footer>

</div>
</body>
</html>